/*
 * Copyright 1998-2010 Linux.org.ru
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *        http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */

package ru.org.linux.util.bbcode;

import junit.framework.Assert;
import org.apache.commons.httpclient.URI;
import org.junit.Before;
import org.junit.Test;
import ru.org.linux.user.User;
import ru.org.linux.spring.Configuration;
import ru.org.linux.user.UserDao;
import ru.org.linux.util.formatter.ToHtmlFormatter;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static ru.org.linux.util.bbcode.tags.QuoteTag.citeFooter;
import static ru.org.linux.util.bbcode.tags.QuoteTag.citeHeader;

/**
 */
public class VulnerabilityTest {

  private UserDao userDao;
  private User user;
  private LorCodeService lorCodeService;
  private ToHtmlFormatter toHtmlFormatter;
  private Configuration configuration;
  private String mainUrl;
  private URI mainURI;

  @Before
  public void initTest() throws Exception {
    userDao = mock(UserDao.class);
    user = mock(User.class);

    when(user.isBlocked()).thenReturn(false);
    when(user.getNick()).thenReturn("splinter");
    when(userDao.getUser("splinter")).thenReturn(user);

    mainUrl = "http://127.0.0.1:8080/";
    mainURI = new URI(mainUrl, true, "UTF-8");

    configuration = mock(Configuration.class);
    when(configuration.getMainURI()).thenReturn(mainURI);
    when(configuration.getMainUrl()).thenReturn(mainUrl);


    toHtmlFormatter = new ToHtmlFormatter();
    toHtmlFormatter.setConfiguration(configuration);

    lorCodeService = new LorCodeService();
    lorCodeService.userDao = userDao;
    lorCodeService.configuration = configuration;
    lorCodeService.toHtmlFormatter = toHtmlFormatter;
  }


  @Test
  public void urlTest0() {
    Assert.assertEquals("<p><a href=\"http://linux.org.ru\"><p>linux.org.ru</p></a></p>",
        lorCodeService.parseComment("[url=http://linux.org.ru]\n\nlinux.org.ru[/url]", false));
    Assert.assertEquals("<p><a href=\"http://linux.org.ru\">http://linux.org.ru</a></p>",
        lorCodeService.parseComment("[url]\n\nhttp://linux.org.ru[/url]", false));
  }

  @Test
  public void urlTest1() {
    Assert.assertEquals("<p><a href=\"http://linux.org.ru\">http://linux.org.ru</a></p>",
        lorCodeService.parseComment("[url=http://linux.org.ru][/url]", false));
  }

  @Test
  public void paragraphLogicTest() {
    // list
    Assert.assertEquals("<p>some1 text</p><p>some2 text\n</p><ul><li>one\n</li><li>two</li></ul><p><a href=\"http://www.example.com\">http://www.example.com</a> - some3 text</p>",
        lorCodeService.parseComment("some1 text\n\nsome2 text\n[list]\n\n[*]one\n[*]two\n\n[/list]\n\n[url]http://www.example.com[/url] - some3 text", false));
    // b
    Assert.assertEquals("<p><b><p>te</p><p>xt</p></b></p>",
        lorCodeService.parseComment("\n\n[b]\n\nte\n\nxt\n\n[/b]\n\n", false));
    // i
    Assert.assertEquals("<p><i><p>te</p><p>xt</p></i></p>",
        lorCodeService.parseComment("\n\n[i]\n\nte\n\nxt\n\n[/i]\n\n", false));
    // u
    Assert.assertEquals("<p><u><p>te</p><p>xt</p></u></p>",
        lorCodeService.parseComment("\n\n[u]\n\nte\n\nxt\n\n[/u]\n\n", false));
    // s
    Assert.assertEquals("<p><s><p>te</p><p>xt</p></s></p>",
        lorCodeService.parseComment("\n\n[s]\n\nte\n\nxt\n\n[/s]\n\n", false));
    // em
    Assert.assertEquals("<p><em><p>te</p><p>xt</p></em></p>",
        lorCodeService.parseComment("\n\n[em]\n\nte\n\nxt\n\n[/em]\n\n", false));
    // strong
    Assert.assertEquals("<p><strong><p>te</p><p>xt</p></strong></p>",
        lorCodeService.parseComment("\n\n[strong]\n\nte\n\nxt\n\n[/strong]\n\n", false));
    // p
    Assert.assertEquals("<p>te</p><p>xt</p>",
        lorCodeService.parseComment("\n\n[p]\n\nte\n\nxt\n\n[/p]\n\n", false));
    // div
    Assert.assertEquals("<p>te</p><p>xt</p>",
        lorCodeService.parseComment("\n\n[div]\n\nte\n\nxt\n\n[/div]\n\n", false));
    // quote
    Assert.assertEquals(citeHeader + "<p>te</p><p>xt</p>" + citeFooter,
        lorCodeService.parseComment("\n\n[quote]\n\nte\n\nxt\n\n[/quote]\n\n", false));

    // cut
    Assert.assertEquals("<p>te</p><p>xt</p>",
        lorCodeService.parseComment("\n\n[cut]\n\nte\n\nxt\n\n[/cut]\n\n", false));
    //user
    Assert.assertEquals("<p><span style=\"white-space: nowrap\"><img src=\"/img/tuxlor.png\"><a style=\"text-decoration: none\" href=\"http://127.0.0.1:8080/people/splinter/profile\">splinter</a></span></p>",
        lorCodeService.parseComment("\n\n[user]\n\nsplinter\n\n[/user]\n\n", false));

  }

  @Test
  public void splinterTest1() { // http://www.linux.org.ru/forum/linux-org-ru/6448266
    Assert.assertEquals(lorCodeService.parseComment("[url=http://www.fishing.org/][user]splinter[/user][/url]", false),
        "<p><a href=\"http://www.fishing.org/\">http://www.fishing.org/</a><span style=\"white-space: nowrap\"><img src=\"/img/tuxlor.png\"><a style=\"text-decoration: none\" href=\"http://127.0.0.1:8080/people/splinter/profile\">splinter</a></span></p>");
  }
}
