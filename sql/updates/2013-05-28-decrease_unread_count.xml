<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="2013052801" author="Slava Zanko">
        <sql splitStatements="false" stripComments="false"><![CDATA[
CREATE OR REPLACE FUNCTION public.del_event()
RETURNS trigger
LANGUAGE plpgsql
AS $function$
BEGIN
    UPDATE users
        SET unread_events = CASE WHEN unread_events > 0 THEN unread_events-1 ELSE 0 END
        WHERE users.id = OLD.userid;
    RETURN NULL;
END;
$function$
        ]]></sql>
        <rollback><![CDATA[
DROP FUNCTION public.del_event();
        ]]></rollback>
    </changeSet>

    <changeSet id="2013052802" author="Slava Zanko">
        <sql splitStatements="false" stripComments="false"><![CDATA[
CREATE TRIGGER del_event_t
    BEFORE DELETE ON user_events
    FOR EACH ROW
    EXECUTE PROCEDURE del_event();
        ]]></sql>
        <rollback><![CDATA[
DROP TRIGGER del_event_t ON user_events;
        ]]></rollback>
    </changeSet>
</databaseChangeLog>
